<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"  lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<title>Best practices for Cloud access using proxies and Agent Forwarding | Greg Grubbs | Hype Cyclist</title>

<meta property='og:title' content='Best practices for Cloud access using proxies and Agent Forwarding - Greg Grubbs | Hype Cyclist'>
<meta property='og:description' content='short post description'>
<meta property='og:url' content='https://hypecyclist.org/post/2020-04-25-best-stuff-for-things/'>
<meta property='og:site_name' content='Greg Grubbs | Hype Cyclist'>
<meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='cloud'><meta property='article:tag' content='networking'><meta property='article:tag' content='tools'><meta property='article:published_time' content='2020-04-25T13:36:10-06:00'><meta property='article:modified_time' content='2020-04-25T13:36:10-06:00'><meta name='twitter:card' content='summary'><meta name='twitter:site' content='@gregoryg'><meta name='twitter:creator' content='@gregoryg'>


<link href="https://hypecyclist.org/index.xml" rel="alternate" type="application/rss+xml" title="Greg Grubbs | Hype Cyclist" />

<link rel="stylesheet" href="/css/style.css"/><link rel='stylesheet' href='https://hypecyclist.org/css/custom.css'><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
<link rel="canonical" href="https://hypecyclist.org/post/2020-04-25-best-stuff-for-things/">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">
</head>
 
<body>

<section class="section">
  <div class="container">
    <nav id="nav-main" class="nav">
      <div id="nav-name" class="nav-left">
        <a id="nav-anchor" class="nav-item" href="https://hypecyclist.org">
          <h1 id="nav-heading" class="title is-4">Greg Grubbs | Hype Cyclist</h1>
        </a>
      </div>
      <div class="nav-right">
        <nav id="nav-items" class="nav-item level is-mobile"><a class="level-item" aria-label="github" href='https://github.com/gregoryg'
            target='_blank' rel='me noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
    
  </svg>
</i>
            </span>
          </a><a class="level-item" aria-label="linkedin" href='https://linkedin.com/in/gregorygrubbs'
            target='_blank' rel='me noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path stroke-width="1.8" d="m5.839218,4.101561c0,1.211972 -0.974141,2.194011 -2.176459,2.194011s-2.176459,-0.982039 -2.176459,-2.194011c0,-1.211094 0.974141,-2.194011 2.176459,-2.194011s2.176459,0.982917 2.176459,2.194011zm0.017552,3.94922l-4.388022,0l0,14.04167l4.388022,0l0,-14.04167zm7.005038,0l-4.359939,0l0,14.04167l4.360816,0l0,-7.370999c0,-4.098413 5.291077,-4.433657 5.291077,0l0,7.370999l4.377491,0l0,-8.89101c0,-6.915523 -7.829986,-6.66365 -9.669445,-3.259423l0,-1.891237z"/>
    
  </svg>
</i>
            </span>
          </a></nav>
      </div>
    </nav>

    <nav class="nav">
      

      
      <div class="nav-right"><a class="nav-item" href="/about">
          <h2 class="title is-5">About</h2>
        </a><a class="nav-item" href="/post">
          <h2 class="title is-5">Blog</h2>
        </a></div>
      
    </nav>

  </div>
  <script src="/js/navicon-shift.js"></script>
</section>

<section class="section">
  <div class="container">
    <div class="subtitle tags is-6 is-pulled-right">
      
      
<a class="subtitle is-6" href="/tags/cloud/">#cloud</a>



  
  | <a class="subtitle is-6" href="/tags/networking/">#networking</a>
  
  | <a class="subtitle is-6" href="/tags/tools/">#tools</a>
  


      
    </div>
    
    <h2 class="subtitle is-6">April 25, 2020</h2>
    
    <h1 class="title">Best practices for Cloud access using proxies and Agent Forwarding</h1>
    
    <div class="content">
      <img src="/images/nicholas-swanson-d19by2PLaPc-unsplash.jpg" alt="Inline Non-hyperlinked Image" title="The idyllic past"/>
<p>
Cloud providers will get angry with you if you deal with network access by popping huge
holes in the firewall. If you don&#39;t get the angry emails, your account administrator is
getting them. At any rate, the practice of simply popping holes in the firewall for web
app access is not secure. This guide shows how to make use of a SOCKS proxy for all your
web-based access to Cloud VMs.</p>
<div id="outline-container-headline-1" class="outline-2">
<h2 id="headline-1">
Step-by-step guide to setting up and using a SOCKS proxy
</h2>
<div id="outline-text-headline-1" class="outline-text-2">
<p>
For worry-free, fire-and-forget proxy usage create and/or steal a <code class="verbatim">proxy.pac</code> file, which
will contain rules for using the proxy for various cloud providers. I use the following
file for AWS, Google Cloud Platform and Microsoft Azure. My example is semi-fancy because
it assumes two different proxy ports - this is to allow one proxy to handle a cluster on
AWS or Azure, and another concurrent proxy to handle a cluster on GCP</p>
<p>
Note that my <code class="verbatim">proxy.pac</code> does not attempt to match all the possible Class C addresses that
will be used - that&#39;s a losing battle, and they will overlap with each other as well as
our own internal ranges. So always use the fully qualified host name of the instances used
by the cloud providers instead.</p>
<figure>
<div class="src src-js">
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span>  <span style="color:#080;font-style:italic">// Allow for two ports; prefer 8157 for EC2, 8158 for Google
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>  <span style="color:#a2f;font-weight:bold">function</span> FindProxyForURL(url, host) {
</span></span><span style="display:flex;"><span>      <span style="color:#080;font-style:italic">// match AWS external and internal DNS
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>      <span style="color:#a2f;font-weight:bold">if</span> (shExpMatch(host, <span style="color:#b44">&#34;*ec2.amazonaws.com&#34;</span>) <span style="color:#666">||</span> shExpMatch(host,
</span></span><span style="display:flex;"><span>                                                               <span style="color:#b44">&#34;ip-*.internal&#34;</span>)) {
</span></span><span style="display:flex;"><span>          <span style="color:#080;font-style:italic">// return &#34;SOCKS5 localhost:8157;SOCKS5 localhost:8158&#34;;
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>          <span style="color:#a2f;font-weight:bold">return</span> <span style="color:#b44">&#34;SOCKS5 localhost:8157&#34;</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#080;font-style:italic">// match Google Cloud internal DNS (they do not provide external
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>      DNS by <span style="color:#a2f;font-weight:bold">default</span> (<span style="color:#666">?</span>) )
</span></span><span style="display:flex;"><span>  <span style="color:#a2f;font-weight:bold">if</span> (shExpMatch(host, <span style="color:#b44">&#34;*.internal&#34;</span>)) {
</span></span><span style="display:flex;"><span>      <span style="color:#080;font-style:italic">// return &#34;SOCKS5 localhost:8158; SOCKS5 localhost:8157&#34;;
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>      <span style="color:#a2f;font-weight:bold">return</span> <span style="color:#b44">&#34;SOCKS5 localhost:8158&#34;</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#080;font-style:italic">// // match AWS and Google Cloud URLs
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>  <span style="color:#080;font-style:italic">// if (shExpMatch(host, &#34;ec2-master&#34;) || shExpMatch(host, &#34;*ec2*.
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>  amazonaws.com<span style="color:#b44">&#34;) || shExpMatch(host, &#34;</span><span style="color:#666">*</span>.internal<span style="color:#b44">&#34;)) {
</span></span></span><span style="display:flex;"><span><span style="color:#b44">   // return &#34;</span>SOCKS5 localhost<span style="color:#666">:</span><span style="color:#666">8157</span><span style="color:#b44">&#34;;
</span></span></span><span style="display:flex;"><span><span style="color:#b44">   // }
</span></span></span><span style="display:flex;"><span><span style="color:#b44">   // match Azure compute URLs
</span></span></span><span style="display:flex;"><span><span style="color:#b44">   if (shExpMatch(host, &#34;</span><span style="color:#666">*</span>.cloudapp.azure.com<span style="color:#b44">&#34;)) {
</span></span></span><span style="display:flex;"><span><span style="color:#b44">   return &#34;</span>SOCKS5 localhost<span style="color:#666">:</span><span style="color:#666">8157</span>; DIRECT<span style="color:#b44">&#34;;
</span></span></span><span style="display:flex;"><span><span style="color:#b44">   }
</span></span></span><span style="display:flex;"><span><span style="color:#b44">   // // Class C address in 10.* range
</span></span></span><span style="display:flex;"><span><span style="color:#b44">   // if (shExpMatch(host, &#34;</span><span style="color:#666">10.</span><span style="color:#666">*</span><span style="color:#b44">&#34;)) {
</span></span></span><span style="display:flex;"><span><span style="color:#b44">   // return &#34;</span>SOCKS5 localhost<span style="color:#666">:</span><span style="color:#666">8157</span>; DIRECT<span style="color:#b44">&#34;;
</span></span></span><span style="display:flex;"><span><span style="color:#b44">   // }
</span></span></span><span style="display:flex;"><span><span style="color:#b44">   // All other requests go direct, not through the proxy
</span></span></span><span style="display:flex;"><span><span style="color:#b44">   return &#34;</span>DIRECT<span style="">&#34;</span>;
</span></span><span style="display:flex;"><span>  }</span></span></code></pre></div>
</div>
<figcaption>
proxy.pac
</figcaption>
</figure>
<div id="outline-container-headline-2" class="outline-3">
<h3 id="headline-2">
Set the <code class="verbatim">.pac</code> file to be used automatically in your OS. 
</h3>
<div id="outline-text-headline-2" class="outline-text-3">
<p>You can set up a simple web server like mongoose, or use a file URL</p>
<div id="outline-container-headline-3" class="outline-4">
<h4 id="headline-3">
Windows
</h4>
<div id="outline-text-headline-3" class="outline-text-4">
<ul>
<li>Internet Options &gt; Connections -&gt; LAN Settings -&gt; Automatic configuration <a href="///path/to/my/proxy.pac">///path/to/my/proxy.pac</a></li>
</ul>
</div>
</div>
<div id="outline-container-headline-4" class="outline-4">
<h4 id="headline-4">
OS X
</h4>
<div id="outline-text-headline-4" class="outline-text-4">
<ul>
<li>System Preferences -&gt; interface (e.g., Wifi) -&gt; Advanced -&gt; Proxies; Select Auto Proxy Discovery and Automatic Proxy</li>
<li>Configuration with a file URL as for Windows</li>
</ul>
</div>
</div>
<div id="outline-container-headline-5" class="outline-4">
<h4 id="headline-5">
Linux
</h4>
<div id="outline-text-headline-5" class="outline-text-4">
<ul>
<li>set environment variable <code class="verbatim">auto_proxy</code></li>
</ul>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-6" class="outline-3">
<h3 id="headline-6">
Choose one of your hosts that has an external IP as a bastion host
</h3>
<div id="outline-text-headline-6" class="outline-text-3">
<p>For example, the NAT gateway host</p>
<div id="outline-container-headline-7" class="outline-4">
<h4 id="headline-7">
Use openssh from your workstation to that host
</h4>
<div id="outline-text-headline-7" class="outline-text-4">
<p>The command below initiates a SOCKS proxy and forwards ssh-agent</p>
<div class="src src-bash">
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>  ssh -A -D <span style="color:#666">8157</span> <span style="color:#666">{</span>user<span style="color:#666">}</span>@<span style="color:#666">{</span>external_ip<span style="color:#666">}</span></span></span></code></pre></div>
</div>
<p>
   The <code class="verbatim">-A</code> option forwards ssh-agent and starts a SOCKS proxy on port 8157 of your
   workstation. I&#39;m not showing the <code class="verbatim">-i</code> option pointing to my key because I always use
   ssh-agent instead</p>
<p>
   Unlike most references on the net, I&#39;m not specifying the <code class="verbatim">-N</code> option because I like
   having an interactive shell and don&#39;t mind sharing it with proxy traffic.</p>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-8" class="outline-3">
<h3 id="headline-8">
Access your web interfaces using the proxy
</h3>
<div id="outline-text-headline-8" class="outline-text-3">
<p>Now point your browser to the fully qualified <strong>internal</strong> host name of the host you want,
   and enjoy the benefits of proper proxy use with zero changes to the firewall/security
   group of your cluster instances</p>
<p>
   Example:</p>
<pre class="example">
  http://ip-1-2-3-4.us-west-1.compute.internal:7180/
  http://my-instance-1.c.my-gcp-project.internal:7180/
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-9" class="outline-2">
<h2 id="headline-9">
Related articles
</h2>
<div id="outline-text-headline-9" class="outline-text-2">
<p>I made a <a href="https://www.youtube.com/watch?v=0at39XhCevs&amp;t=804s">detailed video</a> about this on YouTube - if you want to skip to any specific part,
use the Table of Contents that you will find in the video&#39;s description.</p>
</div>
</div>
      
    </div>
    
  </div>
</section>

    <script src="/js/copycode.js"></script>


<section class="section">
  <div class="container">
    <aside><div id="disqus_thread"></div></aside>
  
    <script type="text/javascript">
      var disqus_shortname = 'hypecyclist';
      function disqus() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }
  
      disqus();
  

    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
  </div>
</section>





<section class="section">
  <div class="container has-text-centered">
    <p>&copy; <a href="https://github.com/gregoryg">Greg Grubbs</a> 2008-2021</p>
    
      <p id="powered-by">Powered by <a href="https://gohugo.io/">Hugo</a> &amp; <a href="https://github.com/ribice/kiss">Kiss</a>.</p>
    
  </div>
</section>

<script type="text/javascript">
  var _paq = _paq || [];
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="\/\/matomo.example.com\/";
    _paq.push(['setTrackerUrl', u+'piwik.php']);
    _paq.push(['setSiteId', '1']);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'piwik.js'; s.parentNode.insertBefore(g,s);
  })();
</script>
<noscript>
  <img src="//matomo.example.com/piwik.php?idsite=1&amp;rec=1" style="border:0" alt="">
</noscript>

<script>
    (function(f, a, t, h, o, m){
        a[h]=a[h]||function(){
            (a[h].q=a[h].q||[]).push(arguments)
        };
        o=f.createElement('script'),
        m=f.getElementsByTagName('script')[0];
        o.async=1; o.src=t; o.id='fathom-script';
        m.parentNode.insertBefore(o,m)
    })(document, window, '\/\/fathom.example.com\/tracker.js', 'fathom');
    fathom('trackPageview');
</script>


</body>
</html>

